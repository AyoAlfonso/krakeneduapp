{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/discourse.ts","webpack:///external \"@prisma/client\"","webpack:///./lib/prisma.ts","webpack:///external \"next/router\"","webpack:///external \"querystring\"","webpack:///./pages/sso.ts","webpack:///external \"crypto\"","webpack:///external \"react-hyperscript\"","webpack:///./src/constants.ts","webpack:///./src/token.ts","webpack:///external \"cookie\""],"names":["headers","process","env","DISCOURSE_API_KEY","DISCOURSE_API_USERNAME","fetchWithBackoff","url","options","exponent","result","fetch","status","value","Promise","resolve","backoff","Math","min","floor","random","setTimeout","createGroup","group","console","log","owner_usernames","join","DISCOURSE_URL","method","body","JSON","stringify","text","json","updateTopic","topic","input","username","tags","title","topicData","postID","post_stream","posts","id","post","raw","post_ids","createTopic","asUser","createCategory","name","color","text_color","category","updateGroup","prisma","discourse_groups","update","where","data","updateCategory","getCategory","path","res","getUsername","userId","user","getGroupId","groupName","undefined","addMember","groupId","usernames","getTaggedPost","c","tag","topic_list","topics","topicID","find","includes","topicRequest","makeSSOPayload","params","payload","Buffer","from","querystring","toString","sig","crypto","createHmac","DISCOURSE_SECRET","sso","digest","syncSSO","createPost","globalAny","global","APP_ENV","PrismaClient","SSO","error","router","useRouter","query","h","getServerSideProps","req","token","getToken","writeHead","Location","encodeURIComponent","end","props","hmac1","verifySig","nonce","parse","email","external_id","setTokenHeader","cookie","serialize","expires","Date","now","httpOnly","sameSite","cookies","loginToken","removeToken","setHeader"],"mappings":"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","file":"pages/sso.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = require('../ssr-module-cache.js');\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tvar threw = true;\n \t\ttry {\n \t\t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n \t\t\tthrew = false;\n \t\t} finally {\n \t\t\tif(threw) delete installedModules[moduleId];\n \t\t}\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 81);\n","import crypto from 'crypto'\nimport querystring from 'querystring'\nimport {DISCOURSE_URL} from 'src/constants'\nimport prisma from \"lib/prisma\";\nlet headers = {\n      \"Api-Key\": process.env.DISCOURSE_API_KEY || '',\n      \"Api-Username\": process.env.DISCOURSE_API_USERNAME || '',\n    }\n\nlet fetchWithBackoff = async (url: Parameters<typeof fetch>[0], options:Parameters<typeof fetch>[1], exponent: number = 1):ReturnType<typeof fetch> => {\n  let result = await fetch(url, options)\n  if(result.status === 429) {\n    let value = 1000 * (2**exponent)\n    await new Promise<void>((resolve)=>{\n      let backoff = Math.min(value + Math.floor(Math.random()*value), 64000)\n      setTimeout(()=>resolve(), backoff)\n    })\n    return fetchWithBackoff(url, options, exponent+1)\n  }\n  return result\n}\n\nexport type Category = {\n  topic_list: {\n    topics: Array<{\n      category_id: number\n      id: string\n      pinned: boolean\n      tags: string[]\n    }>\n  }\n}\n\nexport async function createGroup(group:{\n  name: string,\n  visibility_level: number,\n  owner_usernames: string | string[],\n  mentionable_level?: number,\n  messageable_level?: number\n}) {\n  console.log(group, \"grouphere\")\n  if(typeof group.owner_usernames !== 'string') group.owner_usernames = group.owner_usernames.join(',')\n  let result = await fetchWithBackoff(`${DISCOURSE_URL}/admin/groups`, {\n    method: 'POST',\n    headers: {\n      ...headers,\n      \"Content-Type\": 'application/json; charset=utf-8'\n    },\n    body: JSON.stringify({group})\n  })\n\n   console.log(result, \"grouphereafter\")\n\n  if(result.status !== 200) {\n    console.log(await result.text())\n    return false\n  }\n  return await result.json() as {basic_group: {id: number}}\n}\n\nexport async function updateTopic(topic:string, input: {category_id: number, title: string, raw: string, tags: string[]}, username?: string) {\n  await fetch (`${DISCOURSE_URL}${topic}`, {\n    method: \"PUT\",\n    headers:{\n      \"Content-Type\": 'application/json; charset=utf-8',\n      ...headers\n    },\n    body: JSON.stringify({\n      tags: input.tags,\n      title: input.title\n    })\n  })\n\n  // Update the content\n  let topicData = await (await fetchWithBackoff(`${DISCOURSE_URL}${topic}.json`, {headers})).json()\n  let postID = topicData.post_stream.posts[0].id\n  await fetch (`${DISCOURSE_URL}/posts/${postID}`, {\n    method: \"PUT\",\n    headers:{\n      \"Content-Type\": 'application/json; charset=utf-8',\n      ...headers\n    },\n    body: JSON.stringify({\n      post: {\n        raw: input.raw\n      }\n    })\n  })\n\n  // Update the owner\n  if(username) await fetchWithBackoff(`${DISCOURSE_URL}/t/${topicData.id}/change-owner`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": 'application/json; charset=utf-8',\n      ...headers\n    },\n    body: JSON.stringify({post_ids: [postID], username})\n  })\n}\n\nexport async function createTopic(input:{title: string, category: number | string, raw: string, tags?: string[]}, asUser?: string) {\n  console.log(asUser, \"asUser\")\n  let result = await fetchWithBackoff(`${DISCOURSE_URL}/posts.json`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": 'application/json; charset=utf-8',\n      ...headers,\n      \"Api-Username\": headers[\"Api-Username\"]\n    },\n    body: JSON.stringify(input)\n  })\n  if(result.status !== 200) {\n    console.log(await result.text())\n  }\n  if(result.status === 200)  return await result.json() as {id: string, topic_id: number}\n}\n\nexport const createCategory = async (name: string, options?: {\n  slug?: string,\n  permissions?: {[key:string]:number},\n  parent_category_id?: number,\n  show_subcategory_list?: boolean,\n  subcategory_list_style?: \"rows_with_featured_topics\",\n  default_list_filter?:\"none\"\n}) => {\n  let result = await fetchWithBackoff(`${DISCOURSE_URL}/categories.json`, {\n    method: 'POST',\n    headers: {\n      ...headers,\n      \"Content-Type\": 'application/json; charset=utf-8'\n    },\n    body: JSON.stringify({name, color: '0088CC', text_color: 'FFFFFF', ...options})\n  })\n  if(result.status === 200) return (await result.json()).category as {id: number, topic_url: string}\n  console.log(await result.text())\n  return false as const\n}\n\nexport async function updateGroup(id: number, name: string) {\n  let result = await fetchWithBackoff(`${DISCOURSE_URL}/g/${id}.json`, {\n    method: \"PUT\",\n    headers: {\n      ...headers,\n      \"Content-Type\": 'application/json; charset=utf-8'\n    },\n    body: JSON.stringify({name})\n  })\n  if(result.status !== 200) console.log(await result.text())\n  else {\n    \n    await prisma.discourse_groups.update({where:{id}, data:{name}})\n    return true\n  }\n}\n\nexport async function updateCategory (id: string | number, options: {permissions?: {[key:string]: number}, name: string, slug?: string}) {\n  let result = await fetchWithBackoff(`${DISCOURSE_URL}/categories/${id}`, {\n    method: \"PUT\",\n    headers: {\n      ...headers,\n      \"Content-Type\": 'application/json; charset=utf-8'\n    },\n    body: JSON.stringify({...options, color: '0088CC', text_color: 'FFFFFF'})\n  })\n  if(result.status !== 200) console.log(await result.text())\n  else return true\n}\nexport async function getCategory(path: string | number){\n  let res = await fetchWithBackoff(`${DISCOURSE_URL}/c/${path}.json`, {\n    method: 'GET',\n    headers: {\n      ...headers,\n      \"Content-Type\": 'application/json; charset=utf-8',\n    },\n  })\n  if(res.status === 200){\n    let category = await res.json() as Category\n    return category\n  }\n  else console.log(await res.text())\n}\n\nexport const getUsername = async (userId:string):Promise<string | undefined> => {\n  let result = await fetchWithBackoff(`${DISCOURSE_URL}/u/by-external/${userId}.json`, {\n    method: \"GET\",\n    headers\n  })\n\n  if(result.status === 200) {\n    return (await result.json()).user.username as string\n  }\n  else return\n}\n\nexport const getGroupId = async (groupName:string) => {\n  let result = await fetchWithBackoff(`${DISCOURSE_URL}/groups/${groupName}.json`, {\n    method: \"GET\",\n    headers\n  })\n  if(result.status === 200) return (await result.json()).group.id\n  return undefined\n}\n\nexport const addMember = async (groupId:number, username: string) => {\n  let result = await fetchWithBackoff(`${DISCOURSE_URL}/groups/${groupId}/members.json`, {\n    method: \"PUT\",\n    headers: {\n      ...headers,\n      \"Content-Type\": 'application/json; charset=utf-8',\n    },\n    body: JSON.stringify({\n      usernames: username\n    })\n  })\n  return result.status  === 200\n}\n\nexport const getTaggedPost = async (c: string | number, tag: string) => {\n\n\n  let res = await fetchWithBackoff(`${DISCOURSE_URL}/c/${c}.json`, {\n    method: 'GET',\n    headers: {\n      ...headers,\n      \"Content-Type\": 'application/json; charset=utf-8',\n    },\n  })\n\n  if(res.status !== 200) console.log(await res.text())\n  let category = await res.json() as Category\n  console.log(category.topic_list.topics, tag , \"category\")\n  let topicID = category.topic_list.topics.find((topic) => topic.tags && topic.tags.includes(tag))?.id\n  if(!topicID) return {text: '', id: ''}\n  let topicRequest = await fetchWithBackoff(`${DISCOURSE_URL}/raw/${topicID}`, {headers})\n  return {text: await topicRequest.text(), id: topicID}\n}\n\nexport const makeSSOPayload = (params: {[key:string]: string}) => {\n  let payload = (Buffer.from(querystring.stringify(params))).toString('base64')\n  const sig = crypto.createHmac('sha256', process.env.DISCOURSE_SECRET || '');\n  sig.update(payload)\n\n  let result = querystring.stringify({\n    sso:payload,\n    sig: sig.digest('hex')\n  })\n  return result\n}\n\nexport const syncSSO = async (params: {[key:string]: string})=>{\n  let payload = (Buffer.from(querystring.stringify(params))).toString('base64')\n  const sig = crypto.createHmac('sha256', process.env.DISCOURSE_SECRET || '');\n\n  sig.update(payload)\n  return fetchWithBackoff(`${DISCOURSE_URL}/admin/users/sync_sso`, {\n    method: \"POST\",\n    headers: {\n      \"Api-Key\": process.env.DISCOURSE_API_KEY || '',\n      \"Api-Username\": 'system',\n      \"Content-Type\": 'application/json; charset=utf-8'\n    },\n    body: JSON.stringify({\n      sso: payload,\n      sig: sig.digest('hex')\n    })\n  })\n}\n\nexport async function createPost(params:{topic_id: number,raw:string}) {\n  let result = await fetchWithBackoff(`${DISCOURSE_URL}/posts.json`, {\n    method: \"POST\",\n    headers: {\n      \"Content-Type\": 'application/json; charset=utf-8',\n      ...headers,\n      \"Api-Username\":'system'\n    },\n    body: JSON.stringify(params)\n  })\n  console.log(result)\n}\n","module.exports = require(\"@prisma/client\");","const globalAny:any = global;\nimport { PrismaClient } from \"@prisma/client\";\n\nlet prisma: PrismaClient;\n\nif (process.env.APP_ENV === \"production\") {\n  prisma = new PrismaClient();\n} else {\n  if (!globalAny.prisma) {\n    globalAny.prisma = new PrismaClient();\n  }\n  prisma = globalAny.prisma;\n}\n\nexport default prisma;","module.exports = require(\"next/router\");","module.exports = require(\"querystring\");","import h from 'react-hyperscript'\nimport querystring from 'querystring'\nimport crypto from 'crypto'\nimport {useRouter} from 'next/router'\nimport { GetServerSideProps } from 'next'\n\nimport {getToken} from 'src/token'\nimport {  makeSSOPayload } from 'src/discourse'\nimport {DISCOURSE_URL} from 'src/constants'\n\ntype Props = {error:boolean}\nconst SSO = ({error}:Props) => {\n  let router = useRouter()\n  let {sso, sig} = router.query\n\n  if(!sso || !sig) return h('div', 'Invalid SSO parameters!')\n\n  if(error) return h('p', 'An error occured, please check with the reffering site')\n\n  return h('h1', 'Logging you onto discourse...')\n}\n\nexport default SSO\n\nexport const getServerSideProps:GetServerSideProps = async ({req,res, query}) => {\n  let token = getToken(req)\n  if(!token) {\n    res.writeHead(301, {Location: '/login?redirect='+encodeURIComponent(req.url as string)})\n    res.end()\n    return {props:{}}\n  }\n  let {sso, sig} = query\n  if(typeof sso !== 'string') return {props: {error: true}}\n\n  const hmac1 = crypto.createHmac('sha256', process.env.DISCOURSE_SECRET || '');\n  hmac1.update(Buffer.from(sso))\n\n  let verifySig = hmac1.digest('hex')\n  if(verifySig !== sig) return  {props: {error: true}}\n\n  let {nonce} = querystring.parse(Buffer.from(sso as string, 'base64').toString())\n\n  res.writeHead(301, {\n    Location: `${DISCOURSE_URL}/session/sso_login?`\n      + makeSSOPayload({\n        nonce:nonce as string ,\n        email:token.email,\n        external_id: token.id\n      })\n  })\n  res.end()\n  return {props:{}}\n\n}\n","module.exports = require(\"crypto\");","module.exports = require(\"react-hyperscript\");","export let DISCOURSE_URL = 'https://forum.krakenedu.com'\n","import { ServerResponse, IncomingMessage } from \"http\";\nimport cookie from 'cookie'\n\nexport type Token = {\n  email: string,\n  id: string,\n  username: string,\n  display_name?: string | null,\n  link?: string | null\n  bio?: string | null\n  admin?: boolean\n}\n\nexport function setTokenHeader(token:Token)  {\n  return {\n    'Set-Cookie':cookie.serialize('loginToken', JSON.stringify(token), {\n      path: '/',\n      expires: new Date(Date.now() + 1000 * 60 * 60 * 24 * 30), // 30 days\n      httpOnly: true,\n      sameSite: \"lax\"\n    })\n  }\n}\n\nexport function getToken(req:IncomingMessage) {\n  const cookies = req.headers.cookie\n  if (!cookies) return;\n\n  const { loginToken } = cookie.parse(cookies);\n  if(loginToken) return JSON.parse(loginToken) as Token;\n  return\n}\n\nexport function removeToken(res:ServerResponse) {\n  res.setHeader(\n      'Set-Cookie',\n      cookie.serialize('loginToken', '', {\n        path: '/',\n        expires: new Date(Date.now() - 1000),\n        httpOnly: false\n      })\n    );\n}\n","module.exports = require(\"cookie\");"],"sourceRoot":""}