{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///external \"ical.js\"","webpack:///external \"@prisma/client\"","webpack:///./lib/prisma.ts","webpack:///./pages/api/user_calendar.ts"],"names":["globalAny","global","prisma","process","env","APP_ENV","PrismaClient","getUserEvents","req","res","calendar_ID","query","id","calendar","ICAL","Component","updatePropertyWithValue","window","location","origin","user_cohorts","facilitator_cohorts","standalone","Promise","all","people_in_cohorts","findMany","where","people","calendar_id","course_cohorts","live","select","courses","name","cohort_events","OR","everyone","events","people_in_events","some","standalone_events","enrolled_events","flatMap","cohort","course","cohort_id","map","ev","facilitating_events","concat","event","vevent","calEvent","Event","uid","description","summary","startDate","Time","fromJSDate","Date","start_date","endDate","end_date","addSubcomponent","setHeader","send","toString"],"mappings":"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","file":"pages/api/user_calendar.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = require('../../ssr-module-cache.js');\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tvar threw = true;\n \t\ttry {\n \t\t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n \t\t\tthrew = false;\n \t\t} finally {\n \t\t\tif(threw) delete installedModules[moduleId];\n \t\t}\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 29);\n","module.exports = require(\"ical.js\");","module.exports = require(\"@prisma/client\");","const globalAny:any = global;\nimport { PrismaClient } from \"@prisma/client\";\n\nlet prisma: PrismaClient;\n\nif (process.env.APP_ENV === \"production\") {\n  prisma = new PrismaClient();\n} else {\n  if (!globalAny.prisma) {\n    globalAny.prisma = new PrismaClient();\n  }\n  prisma = globalAny.prisma;\n}\n\nexport default prisma;","import { events } from \"@prisma/client\";\nimport ICAL from 'ical.js'\nimport { NextApiRequest, NextApiResponse } from \"next\";\nimport prisma from \"lib/prisma\";\n\nexport default async function getUserEvents(req: NextApiRequest, res: NextApiResponse) {\n  let calendar_ID = req.query.id as string\n  let calendar = new ICAL.Component(['vcalendar',[],[]])\n  calendar.updatePropertyWithValue('version', '2.0');\n  calendar.updatePropertyWithValue('prodid', `${window.location.origin}`);\n  calendar.updatePropertyWithValue('method', \"PUBLISH\")\n  calendar.updatePropertyWithValue('name', 'KrakenEdu Calendar')\n  calendar.updatePropertyWithValue('x-wr-calname', 'KrakenEdu Calendar')\n\n  let [user_cohorts, facilitator_cohorts, standalone] = await Promise.all([\n    prisma.people_in_cohorts.findMany({\n      where: {\n        people: {calendar_id: calendar_ID},\n        course_cohorts: {live: true}\n      },\n      select: {\n        course_cohorts: {\n          select: {\n            id: true,\n            courses: {\n              select: {\n                name: true\n              }\n            },\n            cohort_events: {\n              where:{\n                OR:[\n                  {everyone: true},\n                  {events:{people:{calendar_id:calendar_ID}}},\n                  {events:{people_in_events:{some:{people:{calendar_id: calendar_ID}}}}}\n                ]\n              },\n              select: {\n                events: true\n              }\n            }\n          }\n        }\n      }\n    }),\n    prisma.course_cohorts.findMany({\n      where:{\n        live: true,\n        people:{\n          calendar_id: calendar_ID\n        }\n      },\n      select: {\n        id: true,\n        courses: {\n          select: {\n            name: true\n          }\n        },\n        cohort_events: {\n          select: {\n            events: true\n          }\n        }\n      }\n    }),\n    prisma.standalone_events.findMany({\n      select: {\n        events: true\n      },\n      where: {\n        OR:[\n          {\n            events: {people_in_events: {some: {people:{calendar_id: calendar_ID}}}}\n          },\n          {\n            events:{people:{calendar_id: calendar_ID}}\n          }\n        ]\n      }\n    })\n  ])\n\n  let enrolled_events = user_cohorts.flatMap(cohort => {\n    let course = cohort.course_cohorts.courses.name\n    let cohort_id = cohort.course_cohorts.id\n    return cohort.course_cohorts.cohort_events.map(ev => {return {...ev.events, course, cohort_id}})\n  })\n  let facilitating_events = facilitator_cohorts.flatMap(cohort=>{\n    let course = cohort.courses.name\n    let cohort_id = cohort.id\n    return cohort.cohort_events.map(ev => {return {...ev.events, course, cohort_id}})\n  })\n\n  let standalone_events = standalone.map(ev=>{\n    return ev.events\n  })\n\n  let events:Array<events & Partial<{course: string, cohort_id: number}>> = standalone_events.concat(enrolled_events).concat(facilitating_events)\n\n  for(let event of events) {\n    let vevent = new ICAL.Component('vevent')\n    let calEvent = new ICAL.Event(vevent)\n    calEvent.uid = 'krakenedu-'+event.id\n    calEvent.description = event.description\n    calEvent.summary = event.course ? (event.course + ' - ' + event.name) : event.name\n    calEvent.location = event.location\n    calEvent.startDate = ICAL.Time.fromJSDate(new Date(event.start_date), true)\n    calEvent.endDate = ICAL.Time.fromJSDate(new Date(event.end_date), true)\n\n    calendar.addSubcomponent(vevent)\n  }\n\n  res.setHeader('Content-type', \"text/calendar\")\n  res.send(calendar.toString())\n}\n"],"sourceRoot":""}